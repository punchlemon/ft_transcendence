## Tournament Mode — 定義と実装計画

概要: トーナメントモードは複数ラウンドで進行する対戦シーケンスであり、試合の進行や操作権はサーバ側で厳密に管理される必要があります。以下はルール定義と実装計画です。

- **ルール（要約）:**
    - **Next Match 可視性:** 最後の試合（決勝）を除き、試合が終了した際に表示される "Next Match"（または該当試合に遷移する操作）は、次の対戦に割り当てられた当事者（2名）のみが利用できる。その他の参加者と観戦者には表示しないか無効化する。
    - **観戦者 (Spectator):** 観戦者にはゲーム入力（キーボード/操作送信）を受け付けさせない。クライアント側で UI を無効化すると同時に、サーバ側でも入力を拒絶する必要がある（セキュリティ／整合性のため）。
    - **参加者離脱時の無効化:** トーナメント参加者のいずれかが大会進行中にルームを離脱した場合、そのトーナメントは無効化（中止）とし、サーバは関係するクライアントへ `tournament_invalid` / `session_expired` を送信して UI を破棄／案内する。
    - **セッションID:** トーナメント用のセッション/ルーム ID は決定論的（deterministic）に生成する。オーナーと招待されたプレイヤーが同じ URL に入れるようにする（フロント側では既に調整済み）。

- **実装計画（優先順）:**
    1. **調査（短期）** — 既存コードの把握: `GameRoom.tsx`, `MatchCard.tsx`, `BracketView.tsx` とサーバの WebSocket / ゲームゲートウェイを確認して、現在の session/participant 管理の設計差分を特定する。
    2. **仕様ドキュメント化（現在）** — このセクションにルールと実装タスクを記載（完了）。
    3. **フロント: UI 制御** — `GameRoom` とトーナメント関連コンポーネントで、Next Match の可視化／活性化を次の当事者に限定する。観戦者は入力 UI をグレーアウト/非表示にする。
    4. **サーバ: 参加者管理と検証** — セッションごとに参加者リストを保持し、コントロールイベント（Next Match / Start Match 等）はサーバ側で参加者かどうか検証して処理する。参加者離脱を検知したらトーナメントを `INVALID` に更新してブロードキャスト。
    5. **フロント: 破棄ハンドリング** — サーバから `tournament_invalid` / `session_expired` を受けたらモーダルを表示し、結果画面へ移行またはラウンジへ戻す UI を実装する。
    6. **テスト & E2E** — 上記の整合性を自動化テストでカバーする（参加者離脱シナリオ、観戦者入力無効化、Next Match の権限制御）。
    7. **デプロイ準備** — マイグレーション・CI を通過させて本番デプロイする。

- **注意点 / 技術的考慮**
    - クライアント側のみのガードは UX のために重要だが、真の権限検証は常にサーバ側で行う必要がある。競合やレースコンディションを避けるため、サーバ側に次マッチの "ロック" 機構を入れることを推奨する。
    - セッション ID の命名規約は既存と整合させ、URL で衝突しないようにする。オーナー/招待者で同一の deterministic ID を生成する実装を前提とする。

このセクションはトーナメント実装の単一の情報源として更新・運用します。実装タスクを進めるたびにここを更新してください。